# Coverage Validation Architecture

## Overview

This document describes the multi-layered coverage validation architecture that eliminates Codecov as a single point of failure (SPOF) while maintaining robust quality gates and observability.

## Architectural Principles

1. **Quality gates MUST be self-contained** - No external dependencies for pass/fail decisions
2. **External services are observability layers, NOT blocking gates** - Trend tracking, not gatekeeping
3. **System degrades gracefully, never halts on external failure** - Always fail-safe

## Architecture Layers

### Layer 1: Primary Quality Gate (BLOCKING)

**Component:** `scripts/validate_coverage.py`

**Purpose:** Self-contained coverage validation with zero external dependencies

**Behavior:**
- Reads `coverage.json` generated by pytest-cov
- Validates against 85% threshold (SSOT: `pyproject.toml`, `Makefile`)
- Generates markdown report with coverage hotspots
- Exit code 0 on pass, 1 on fail
- **BLOCKS CI** if coverage below threshold

**Implementation:**
```bash
# In CI workflow (.github/workflows/ci-pr-atomic.yml)
- name: Validate coverage (PRIMARY GATE)
  run: python scripts/validate_coverage.py
```

**Output Format:**
```markdown
## ‚úÖ Coverage Report

**Overall Coverage:** 86.25% (778/902 lines)
**Threshold:** 85.0%
**Status:** PASS

### üî• Coverage Hotspots (Lowest 5 Files)

| File | Coverage |
|------|----------|
| `production/jax_backend.py` | 28.6% |
| `sim/network.py` | 68.5% |
...
```

### Layer 2: Observability Layer (NON-BLOCKING)

**Component:** Codecov upload action

**Purpose:** Historical trend tracking and visualization

**Behavior:**
- Uploads coverage.json to Codecov
- `fail_ci_if_error: false` - NEVER blocks CI
- `continue-on-error: true` - Workflow continues on any error
- Provides trend graphs and PR comments when available

**Implementation:**
```yaml
- name: Upload coverage to Codecov (OBSERVABILITY LAYER)
  uses: codecov/codecov-action@v3
  with:
    fail_ci_if_error: false  # COV-002: MUST NOT block CI
  continue-on-error: true
```

**Failure Modes:**
- HTTP 429 (rate limit) ‚Üí CI continues, artifacts preserved
- HTTP 401 (auth error) ‚Üí CI continues, artifacts preserved
- Network timeout ‚Üí CI continues, artifacts preserved
- Service outage ‚Üí CI continues, artifacts preserved

### Layer 3: Artifact Preservation (ALWAYS)

**Component:** GitHub Actions artifact upload

**Purpose:** Coverage reports always available regardless of external service status

**Behavior:**
- `if: always()` - Runs even if previous steps fail
- Uploads both `coverage.json` and `htmlcov/` directory
- 30-day retention for post-mortem analysis
- Accessible via GitHub Actions UI

**Implementation:**
```yaml
- name: Upload coverage artifacts (ALWAYS)
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-report-${{ github.sha }}
    path: |
      coverage.json
      htmlcov/
```

## SSOT Rules

### COV-001: Self-Contained Validation
**Statement:** Coverage validation MUST be self-contained with no external dependencies.

**Rationale:** Quality gates cannot depend on external services that may fail due to rate limits, network issues, or service outages.

**Enforcement:**
- `scripts/validate_coverage.py` - No imports beyond Python stdlib + json
- CI workflow runs validator before Codecov upload

**Verification:**
```bash
# Validator runs successfully without network access
python scripts/validate_coverage.py
```

### COV-002: Non-Blocking Codecov
**Statement:** Codecov MUST NOT block CI (fail_ci_if_error=false, continue-on-error=true).

**Rationale:** External observability services provide value but cannot be allowed to halt development workflow.

**Enforcement:**
- `.github/workflows/ci-pr-atomic.yml` step "Upload coverage to Codecov": `fail_ci_if_error: false`
- `.github/workflows/ci-pr-atomic.yml` step "Upload coverage to Codecov": `continue-on-error: true`

**Verification:**
```bash
# Simulate Codecov failure
export CODECOV_TOKEN="invalid"
# CI still passes if coverage threshold met
```

## Failure Mode Matrix

| Scenario | Primary Gate | Codecov | Artifacts | CI Result |
|----------|-------------|---------|-----------|-----------|
| Coverage 86%, Codecov OK | ‚úÖ PASS | ‚úÖ Uploaded | ‚úÖ Preserved | ‚úÖ PASS |
| Coverage 86%, Codecov HTTP 429 | ‚úÖ PASS | ‚ö†Ô∏è Degraded | ‚úÖ Preserved | ‚úÖ PASS |
| Coverage 83%, Codecov OK | ‚ùå FAIL | ‚úÖ Uploaded | ‚úÖ Preserved | ‚ùå FAIL |
| Coverage 83%, Codecov HTTP 429 | ‚ùå FAIL | ‚ö†Ô∏è Degraded | ‚úÖ Preserved | ‚ùå FAIL |

## Usage

### Local Development

Run coverage with validation:
```bash
make coverage           # Generate coverage.json + htmlcov/
make validate-coverage  # Run self-contained validator
```

### CI Pipeline

Automated in `.github/workflows/ci-pr-atomic.yml`:
1. Run tests with coverage (`pytest --cov`)
2. **Validate coverage** (PRIMARY GATE, blocking)
3. Upload to Codecov (observability, non-blocking)
4. Preserve artifacts (always)

### Troubleshooting

**Coverage below 85%:**
```bash
# Run validator to see hotspots
python scripts/validate_coverage.py

# Output shows lowest coverage files:
# üî• Coverage Hotspots (Lowest 5 Files)
# | File | Coverage |
# | production/jax_backend.py | 28.6% |
# ...

# Add tests for identified hotspots
```

**Codecov HTTP 429:**
```
# Expected behavior: CI continues
# Action required: None
# Observability degraded, quality gate intact
```

## Migration from Legacy Architecture

### Before (SPOF Architecture)
```yaml
- name: Upload coverage to Codecov
  fail_ci_if_error: true  # ‚ùå BLOCKS CI on Codecov failure
```

**Problem:** HTTP 429 from Codecov ‚Üí CI fails ‚Üí PR blocked despite valid tests

### After (Fail-Safe Architecture)
```yaml
- name: Validate coverage (PRIMARY GATE)
  run: python scripts/validate_coverage.py  # ‚úÖ Self-contained

- name: Upload coverage to Codecov (OBSERVABILITY LAYER)
  fail_ci_if_error: false  # ‚úÖ Never blocks CI
  continue-on-error: true  # ‚úÖ Graceful degradation
```

**Benefits:**
- ‚úÖ Codecov downtime does NOT block merges
- ‚úÖ Quality gate remains enforced (85% threshold)
- ‚úÖ Coverage artifacts always preserved
- ‚úÖ No vendor lock-in
- ‚úÖ Deterministic quality gate

## Related Documentation

- [CONTRIBUTING.md](../CONTRIBUTING.md) - Coverage requirements and CI failure modes
- [SSOT_RULES.md](SSOT_RULES.md) - COV-001, COV-002 rule definitions
- [CI_GATES.md](CI_GATES.md) - Complete CI/CD pipeline documentation

## Changelog

**2026-01-25:** Initial architecture implementation
- Created `scripts/validate_coverage.py` (self-contained validator)
- Updated CI workflow to decouple Codecov from quality gate
- Added COV-001, COV-002 SSOT rules
- Documented multi-layered architecture
