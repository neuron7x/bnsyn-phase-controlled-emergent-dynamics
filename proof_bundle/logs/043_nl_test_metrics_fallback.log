     1	from __future__ import annotations
     2	
     3	import importlib
     4	
     5	from benchmarks import metrics
     6	
     7	
     8	def test_process_rss_mb_fallback_without_psutil(monkeypatch) -> None:
     9	    monkeypatch.setattr(metrics.importlib.util, "find_spec", lambda _: None)
    10	
    11	    class FakeUsage:
    12	        ru_maxrss = 4096.0
    13	
    14	    monkeypatch.setattr(metrics.resource, "getrusage", lambda _: FakeUsage())
    15	    monkeypatch.setattr(metrics.os, "name", "posix")
    16	
    17	    rss_mb = metrics._process_rss_mb()
    18	
    19	    assert rss_mb == 4.0
    20	
    21	
    22	def test_process_rss_mb_uses_psutil_when_available(monkeypatch) -> None:
    23	    class FakeProcess:
    24	        def memory_info(self):
    25	            return type("Mem", (), {"rss": 8 * 1024 * 1024})()
    26	
    27	    fake_psutil = type("FakePsutil", (), {"Process": lambda self, _pid: FakeProcess()})()
    28	
    29	    monkeypatch.setattr(metrics.importlib.util, "find_spec", lambda _: object())
    30	    monkeypatch.setattr(importlib, "import_module", lambda _: fake_psutil)
    31	
    32	    rss_mb = metrics._process_rss_mb()
    33	
    34	    assert rss_mb == 8.0
