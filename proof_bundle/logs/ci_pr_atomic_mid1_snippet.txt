        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]" build
      - name: Verify lockfile freshness
        run: |
          python -m pip install pip-tools
          PYENV_VERSION=3.11.14 pip-compile --extra=dev --generate-hashes --output-file=requirements-lock.txt pyproject.toml
          git diff --exit-code -- requirements-lock.txt
      - run: python -m build
      - name: Install from wheel in clean venv
        run: |
          python -m venv .venv-wheel
          . .venv-wheel/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import bnsyn; print(bnsyn.__version__)"

  smoke-wheel-matrix:
    name: smoke-wheel-matrix (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]" build
      - name: Smoke tests
        run: pytest -m smoke -v --tb=short
      - name: Build and install wheel
        run: |
          python -m build
          python -m venv .venv-wheel
          . .venv-wheel/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import bnsyn; print(bnsyn.__version__)"

  tests-smoke:
    needs: gate-profile
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_pytest.yml
    with:
      python-version: ${{ inputs['python-version'] || '3.11' }}
      markers: ${{ needs.gate-profile.outputs.pytest-markers }}
      coverage-threshold: ${{ fromJSON(needs.gate-profile.outputs.coverage-threshold) }}
      upload-codecov: ${{ inputs['upload-codecov'] || true }}
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  validation-tests-pr:
    needs: [changes, gate-profile]
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.validation == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'run-validation') ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_validation_tests.yml
    with:
      markers: ${{ needs.gate-profile.outputs.validation-markers }}
      timeout-minutes: ${{ fromJSON(needs.gate-profile.outputs.validation-timeout-minutes) }}
      summary-title: PR Validation Suite
      upload-artifacts: true
      artifact-name: validation-logs-pr

  property-tests-pr:
    needs: [changes, gate-profile]
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.property == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'run-property') ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_property_tests.yml
    with:
      markers: ${{ needs.gate-profile.outputs.property-markers }}
      timeout-minutes: ${{ fromJSON(needs.gate-profile.outputs.property-timeout-minutes) }}
      hypothesis-profile: ci
      summary-title: PR Property-Based Invariants
      upload-artifacts: true
      artifact-name: property-logs-pr

  docs-pr:
    needs: changes
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.docs == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - run: python -m pip install -e ".[dev,test]"
      - name: Build docs
        run: make docs
      - name: Link check
        run: sphinx-build -b linkcheck docs docs/_build/linkcheck

  pr-description-policy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Validate PR body sections and labels policy
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const body = (context.payload.pull_request?.body || '').toLowerCase();
            const headings = new Set(
              [...body.matchAll(/^#{1,6}\s+(.+)$/gm)].map((match) => match[1].trim())
            );
            const requiredSections = {
              'what changed': ['what changed', 'description', 'summary'],
              'why': ['why', 'motivation', 'context'],
              'risk': ['risk', 'risks', 'breaking changes', 'performance impact', 'additional notes'],
              'evidence': ['evidence', 'testing', 'how to test', 'validation', 'tests', 'verification'],
              'how to test': ['how to test', 'testing', 'test plan', 'commands run'],
            };
            const hasAlias = (alias) => body.includes(alias) || Array.from(headings).some((heading) => heading.includes(alias));
            const missing = Object.entries(requiredSections)
              .filter(([, aliases]) => !aliases.some((alias) => hasAlias(alias)))
              .map(([section]) => section);
            const labels = (context.payload.pull_request?.labels || []).map((l) => l.name);
            const allowed = new Set(['run-property', 'run-validation', 'run-codeql', 'heavy-ci']);
            const unknown = labels.filter((name) => name.startsWith('run-') && !allowed.has(name));
            if (missing.length > 0) {
              core.warning(`PR description is missing recommended sections: ${missing.join(', ')}`);
            }
            if (unknown.length > 0) {
              core.setFailed(`Unknown run-* labels found: ${unknown.join(', ')}`);
              return;
            }
            core.info('PR description and labels policy checks passed.');

  ssot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]"
      - run: python -m scripts.validate_bibliography
      - run: python -m scripts.validate_claims
      - run: python -m scripts.scan_governed_docs
      - run: python -m scripts.scan_normative_tags
      - run: python -m scripts.validate_api_maturity
      - run: python -m scripts.validate_status_claims
      - run: make api-contract
      - run: python -m tools.manifest generate
      - run: python -m tools.manifest validate
      - name: Verify manifest artifacts are in sync
        run: |
          if ! git diff --exit-code -- .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json; then
            echo "::error::.github/REPO_MANIFEST.md and/or manifest/repo_manifest.computed.json are out of date. Run: python -m tools.manifest generate && git add .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json"
            git --no-pager diff -- .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json
            exit 1
          fi

  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]"
      - name: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
