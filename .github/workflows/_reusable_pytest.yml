# REUSABLE NON-PR-GATE: long-running workflow_call; must not run on pull_request/push.
name: Reusable Pytest

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      markers:
        description: 'Pytest marker expression'
        type: string
        default: 'not (validation or property)'
      coverage-threshold:
        description: 'Minimum coverage percentage'
        type: number
        default: 85
      timeout-minutes:
        description: 'Timeout in minutes'
        type: number
        default: 10
      upload-codecov:
        description: 'Upload coverage to Codecov'
        type: boolean
        default: false
    secrets:
      CODECOV_TOKEN:
        description: 'Codecov token (required if upload-codecov is true)'
        required: false

permissions:
  contents: read

jobs:
  pytest:
    name: Pytest (Coverage ${{ inputs['coverage-threshold'] }}%)
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs['timeout-minutes'] }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs['python-version'] }}
          cache: 'pip'
      
      - name: Pin pip
        uses: ./.github/actions/pin-pip

      - name: Log pip version
        run: python -m pip --version

      - name: Install dependencies
        run: python -m pip install -e ".[test,viz]"
      
      - name: Run pytest
        id: pytest
        run: |
          START_TIME=$(date +%s)
          pytest \
            -m "${{ inputs.markers }}" \
            --cov=bnsyn \
            --cov-report=term-missing:skip-covered \
            --cov-report=json \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under="${{ inputs['coverage-threshold'] }}" \
            --junit-xml=junit.xml \
            -v 2>&1 | tee pytest.log
          PYTEST_EXIT=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "PYTEST_RESULT=$PYTEST_EXIT" >> "$GITHUB_ENV"
          echo "DURATION=$DURATION" >> "$GITHUB_ENV"
          exit "$PYTEST_EXIT"
      
      - name: Coverage regression gate
        if: success()
        run: python scripts/check_coverage_gate.py --coverage-xml coverage.xml --baseline quality/coverage_gate.json

      - name: Parse coverage
        if: always()
        id: coverage
        run: |
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
            echo "COVERAGE=$COVERAGE" >> "$GITHUB_ENV"
            
            # Count tests
            if [ -f junit.xml ]; then
              TEST_COUNT=$(grep -c '<testcase' junit.xml || echo "0")
              echo "TEST_COUNT=$TEST_COUNT" >> "$GITHUB_ENV"
            fi
          else
            echo "COVERAGE=N/A" >> "$GITHUB_ENV"
            echo "TEST_COUNT=0" >> "$GITHUB_ENV"
          fi
      
      - name: Generate summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Pytest Results"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            if [ "${{ env.PYTEST_RESULT }}" = "0" ]; then
              echo "| Status |  PASS |"
            else
              echo "| Status |  FAIL |"
            fi
            echo "| Tests Run | ${{ env.TEST_COUNT }} |"
            echo "| Coverage | ${{ env.COVERAGE }}% |"
            echo "| Threshold | ${{ inputs['coverage-threshold'] }}% |"
            echo "| Duration | ${{ env.DURATION }}s |"
            echo "| Markers | \`${{ inputs.markers }}\` |"
            echo "| Python | ${{ inputs['python-version'] }} |"
            echo ""
            
            # Show failure details if tests failed
            if [ "${{ env.PYTEST_RESULT }}" != "0" ]; then
              echo "###  Failure Details"
              echo ""
              
              # Extract failed tests
              if [ -f pytest.log ]; then
                echo "**Failed Tests:**"
                echo "\`\`\`"
                if grep "FAILED" pytest.log | head -10; then
                  true
                else
                  echo "No FAILED markers found"
                fi
                echo "\`\`\`"
                echo ""
              fi
              
              # Show coverage hotspots (lowest 5 files)
              if [ -f coverage.json ]; then
                echo "**Coverage Hotspots (Lowest 5 Files):**"
                echo "\`\`\`"
                if python -c 'import json; data = json.load(open("coverage.json")); files = [(k, v["summary"]["percent_covered"]) for k, v in data.get("files", {}).items()]; files.sort(key=lambda x: x[1]); [print(f"{file}: {cov:.1f}%") for file, cov in files[:5]]' 2>/dev/null; then
                  true
                else
                  echo "Could not parse coverage"
                fi
                echo "\`\`\`"
                echo ""
              fi
              
              # Reproduction commands
              echo "###  Reproduction Commands"
              echo ""
              echo "\`\`\`bash"
              echo "# Clone and setup"
              echo "git clone https://github.com/${{ github.repository }}.git"
              echo "cd ${{ github.event.repository.name }}"
              echo "git checkout ${{ github.sha }}"
              echo ""
              echo "# Install dependencies"
              echo "python${{ inputs['python-version'] }} -m pip install -e \".[test,viz]\""
              echo ""
              echo "# Run tests"
              echo "pytest -m \"${{ inputs.markers }}\" \\"
              echo "  --cov=bnsyn \\"
              echo "  --cov-fail-under=${{ inputs['coverage-threshold'] }} \\"
              echo "  -v"
              echo "\`\`\`"
            fi
          } >> "$summary_file"
      
      - name: Upload coverage to Codecov
        if: inputs['upload-codecov'] && always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.json
          fail_ci_if_error: false
          verbose: true
          flags: pytest-${{ inputs.markers }}
          name: pytest-coverage-${{ github.sha }}
        timeout-minutes: 5
      
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-failure-${{ github.sha }}
          path: |
            pytest.log
            junit.xml
            htmlcov/
            coverage.json
            coverage.xml
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload coverage artifact on success
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: htmlcov/
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Fail if tests failed
        if: env.PYTEST_RESULT != '0'
        run: exit 1
