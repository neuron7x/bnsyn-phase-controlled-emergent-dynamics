# REUSABLE NON-PR-GATE: long-running workflow_call; must not run on pull_request/push.
name: Reusable Pytest

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      markers:
        description: 'Pytest marker expression'
        type: string
        default: 'not (validation or property)'
      coverage-threshold:
        description: 'Minimum coverage percentage'
        type: number
        default: 85
      timeout-minutes:
        description: 'Timeout in minutes'
        type: number
        default: 10
      upload-codecov:
        description: 'Upload coverage to Codecov'
        type: boolean
        default: false
    secrets:
      CODECOV_TOKEN:
        description: 'Codecov token (required if upload-codecov is true)'
        required: false

permissions:
  contents: read

jobs:
  pytest:
    name: Pytest (Coverage ${{ inputs['coverage-threshold'] }}%)
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs['timeout-minutes'] }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] }}
          cache: 'pip'
      
      - name: Pin pip
        uses: ./.github/actions/pin-pip

      - name: Log pip version
        run: python -m pip --version

      - name: Install dependencies
        run: python -m pip install -e ".[test]"
      
      - name: Run pytest
        id: pytest
        run: |
          START_TIME=$(date +%s)
          python -m pytest \
            -m "${{ inputs.markers }}" \
            --cov=bnsyn \
            --cov-report=term-missing:skip-covered \
            --cov-report=json \
            --cov-report=xml:coverage.xml \
            --cov-report=html \
            --cov-fail-under="${{ inputs['coverage-threshold'] }}" \
            --junit-xml=junit.xml \
            -v 2>&1 | tee pytest.log
          PYTEST_EXIT=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "PYTEST_RESULT=$PYTEST_EXIT" >> "$GITHUB_ENV"
          echo "DURATION=$DURATION" >> "$GITHUB_ENV"
          exit "$PYTEST_EXIT"
      
      - name: Coverage regression gate
        if: success()
        run: python -m scripts.check_coverage_gate --coverage-xml coverage.xml --baseline quality/coverage_gate.json

      - name: Parse coverage
        if: always()
        id: coverage
        run: |
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; print(round(float(json.load(open('coverage.json'))['totals']['percent_covered']), 4))")
            echo "COVERAGE=$COVERAGE" >> "$GITHUB_ENV"
          else
            echo "COVERAGE=N/A" >> "$GITHUB_ENV"
          fi

          if [ -f junit.xml ]; then
            TEST_COUNT=$(grep -c '<testcase' junit.xml || echo "0")
            echo "TEST_COUNT=$TEST_COUNT" >> "$GITHUB_ENV"
          else
            echo "TEST_COUNT=0" >> "$GITHUB_ENV"
          fi

      - name: Generate coverage trend artifact
        if: always() && hashFiles('coverage.json') != ''
        run: |
          python -m scripts.generate_coverage_trend \
            --coverage-json coverage.json \
            --output-json artifacts/coverage-trend/coverage-trend.json \
            --output-csv artifacts/coverage-trend/coverage-trend.csv \
            --sha "${{ github.sha }}" \
            --branch "${{ github.ref_name }}"

      - name: Parse coverage state
        if: always() && hashFiles('artifacts/coverage-trend/coverage-trend.json') != ''
        run: |
          COVERAGE_STATE=$(python -c "import json; print(json.load(open('artifacts/coverage-trend/coverage-trend.json'))['coverage_state'])")
          echo "COVERAGE_STATE=$COVERAGE_STATE" >> "$GITHUB_ENV"

      - name: Enforce mandatory coverage.xml artifact input
        if: always()
        run: |
          if [ ! -f coverage.xml ]; then
            echo "coverage.xml is required for smoke/unit coverage jobs"
            exit 1
          fi
      
      - name: Generate summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Pytest Results"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            if [ "${{ env.PYTEST_RESULT }}" = "0" ]; then
              echo "| Status |  PASS |"
            else
              echo "| Status |  FAIL |"
            fi
            echo "| Tests Run | ${{ env.TEST_COUNT }} |"
            echo "| Coverage | ${{ env.COVERAGE }}% |"
            echo "| Coverage State | ${{ env.COVERAGE_STATE || 'N/A' }} |"
            echo "| Threshold | ${{ inputs['coverage-threshold'] }}% |"
            echo "| Duration | ${{ env.DURATION }}s |"
            echo "| Markers | \`${{ inputs.markers }}\` |"
            echo "| Python | ${{ inputs['python-version'] }} |"
            echo ""
            
            # Show failure details if tests failed
            if [ "${{ env.PYTEST_RESULT }}" != "0" ]; then
              echo "###  Failure Details"
              echo ""
              
              # Extract failed tests
              if [ -f pytest.log ]; then
                echo "**Failed Tests:**"
                echo "\`\`\`"
                if grep "FAILED" pytest.log | head -10; then
                  true
                else
                  echo "No FAILED markers found"
                fi
                echo "\`\`\`"
                echo ""
              fi
              
              # Show coverage hotspots (lowest 5 files)
              if [ -f coverage.json ]; then
                echo "**Coverage Hotspots (Lowest 5 Files):**"
                echo "\`\`\`"
                if python -c 'import json; data = json.load(open("coverage.json")); files = [(k, v["summary"]["percent_covered"]) for k, v in data.get("files", {}).items()]; files.sort(key=lambda x: x[1]); [print(f"{file}: {cov:.1f}%") for file, cov in files[:5]]' 2>/dev/null; then
                  true
                else
                  echo "Could not parse coverage"
                fi
                echo "\`\`\`"
                echo ""
              fi
              
              # Reproduction commands
              echo "###  Reproduction Commands"
              echo ""
              echo "\`\`\`bash"
              echo "# Clone and setup"
              echo "git clone https://github.com/${{ github.repository }}.git"
              echo "cd ${{ github.event.repository.name }}"
              echo "git checkout ${{ github.sha }}"
              echo ""
              echo "# Install dependencies"
              echo "python${{ inputs['python-version'] }} -m pip install -e \".[test]\""
              echo ""
              echo "# Run tests"
              echo "python -m pytest -m \"${{ inputs.markers }}\" \\"
              echo "  --cov=bnsyn \\"
              echo "  --cov-fail-under=${{ inputs['coverage-threshold'] }} \\"
              echo "  -v"
              echo "\`\`\`"
            fi
          } >> "$summary_file"
      
      - name: Upload coverage to Codecov
        if: inputs['upload-codecov'] && always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
          flags: pytest-${{ inputs.markers }}
          name: pytest-coverage-${{ github.sha }}
        timeout-minutes: 5
      
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: pytest-failure-${{ github.sha }}
          path: |
            pytest.log
            junit.xml
            htmlcov/
            coverage.json
            coverage.xml
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Upload mandatory coverage.xml artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: coverage-xml-${{ github.sha }}
          path: coverage.xml
          if-no-files-found: error
          retention-days: 30

      - name: Upload coverage HTML report artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: coverage-html-${{ github.sha }}
          path: htmlcov/
          if-no-files-found: ignore
          retention-days: 30

      - name: Upload coverage trend metrics artifact
        if: always() && hashFiles('artifacts/coverage-trend/coverage-trend.json') != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: coverage-trend-metrics
          path: artifacts/coverage-trend/
          if-no-files-found: error
          retention-days: 90
      
      - name: Fail if tests failed
        if: env.PYTEST_RESULT != '0'
        run: exit 1
