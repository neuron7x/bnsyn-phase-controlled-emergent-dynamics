# REUSABLE NON-PR-GATE: long-running workflow_call; must not run on pull_request/push.
name: Reusable Property Tests

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      markers:
        description: 'Pytest marker expression'
        type: string
        default: 'property'
      extra-args:
        description: 'Extra pytest args'
        type: string
        default: '-v --tb=short --hypothesis-show-statistics'
      hypothesis-profile:
        description: 'Hypothesis profile'
        type: string
        default: 'quick'
      log-file:
        description: 'Log file path'
        type: string
        default: 'property.log'
      junit-file:
        description: 'JUnit XML file path'
        type: string
        default: 'property-junit.xml'
      junit-enabled:
        description: 'Enable JUnit XML output'
        type: boolean
        default: true
      summary-title:
        description: 'Summary title'
        type: string
        default: 'Property-Based Invariants (Hypothesis)'
      upload-artifacts:
        description: 'Upload log artifacts'
        type: boolean
        default: false
      upload-hypothesis-cache:
        description: 'Upload .hypothesis cache'
        type: boolean
        default: false
      artifact-name:
        description: 'Artifact name'
        type: string
        default: 'property-logs'
      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        default: 30

permissions:
  contents: read

jobs:
  property-tests:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs['timeout-minutes'] }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: ${{ inputs['python-version'] }}
          cache: 'pip'
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Install dependencies
        run: python -m pip install -e ".[dev,test]"
      - name: Run property tests
        id: property
        run: |
          set +e
          if [ -n "${{ inputs['hypothesis-profile'] }}" ]; then
            export HYPOTHESIS_PROFILE="${{ inputs['hypothesis-profile'] }}"
          fi
          JUNIT_ARGS=""
          if [ "${{ inputs['junit-enabled'] }}" = "true" ]; then
            JUNIT_ARGS="--junit-xml=${{ inputs['junit-file'] }}"
          fi
          pytest -m "${{ inputs.markers }}" ${{ inputs['extra-args'] }} $JUNIT_ARGS 2>&1 | tee "${{ inputs['log-file'] }}"
          TEST_STATUS=${PIPESTATUS[0]}
          echo "TEST_STATUS=$TEST_STATUS" >> "$GITHUB_ENV"
          exit "$TEST_STATUS"
      - name: Generate summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  ${{ inputs['summary-title'] }}"
            echo ""
            echo "### Results"
            echo '```'
            tail -20 "${{ inputs['log-file'] }}" || true
            echo '```'
            echo ""
            echo "### Hypothesis Statistics"
            echo '```'
            if grep -A 100 "Hypothesis Statistics" "${{ inputs['log-file'] }}"; then
              true
            else
              echo "No statistics found"
            fi
            echo '```'
          } >> "$summary_file"
      - name: Upload logs
        if: inputs['upload-artifacts'] && always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ${{ inputs['artifact-name'] }}-${{ github.sha }}
          path: |
            ${{ inputs['log-file'] }}
            ${{ inputs['junit-file'] }}
          if-no-files-found: ignore
          retention-days: 30
      - name: Upload Hypothesis cache
        if: inputs['upload-hypothesis-cache'] && always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: hypothesis-cache-${{ github.sha }}
          path: .hypothesis/
          if-no-files-found: ignore
          retention-days: 30
