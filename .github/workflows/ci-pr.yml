name: ci-pr

on:
  pull_request:
  push:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ssot-governance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-lock.txt
          pip install -e .
      - name: Validate bibliography
        run: python scripts/validate_bibliography.py
      - name: Validate claims
        run: python scripts/validate_claims.py
      - name: Scan normative tags
        run: python scripts/scan_normative_tags.py
      - name: Scan governed docs
        run: python scripts/scan_governed_docs.py

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-lock.txt
          pip install -e .
      - name: Pytest (non-validation)
        run: pytest -m "not validation"

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-lock.txt
          pip install -e .
      - name: Ruff
        run: ruff check .
      - name: Mypy
        run: mypy src

  dependency-security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Dependency review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
      - name: OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: --severity=HIGH --format sarif --output osv.sarif .

  secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz | tar -xz
          sudo mv gitleaks /usr/local/bin/gitleaks
      - name: Gitleaks repo scan
        run: gitleaks detect --source . --report-path gitleaks-repo.sarif --report-format sarif
      - name: Gitleaks PR scan
        if: github.event_name == 'pull_request'
        run: gitleaks detect --source . --report-path gitleaks-pr.sarif --report-format sarif --log-opts "${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
      - name: Create empty PR report
        if: github.event_name != 'pull_request'
        run: |
          cat > gitleaks-pr.sarif <<'SARIF'
          {"version":"2.1.0","runs":[]}
          SARIF
      - name: Upload gitleaks repo report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-repo-${{ github.run_id }}
          path: gitleaks-repo.sarif
      - name: Upload gitleaks PR report
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-pr-${{ github.run_id }}
          path: gitleaks-pr.sarif

  sast:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/analyze@v3

  benchmarks-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-lock.txt
          pip install -e .
          pip install pytest-benchmark
      - name: Run micro-benchmarks
        run: |
          python scripts/run_benchmarks.py --suite ci --output benchmarks/pr-results.json --summary benchmarks/pr-summary.json
      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-pr-${{ github.run_id }}
          path: |
            benchmarks/pr-results.json
            benchmarks/pr-summary.json
