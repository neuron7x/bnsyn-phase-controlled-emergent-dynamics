name: Reusable Quality Checks

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      mypy-strict:
        description: 'Enable mypy strict mode'
        type: boolean
        default: true
      pylint-threshold:
        description: 'Minimum pylint score (0.0-10.0)'
        type: number
        default: 7.5

jobs:
  ruff:
    name: Ruff (Format + Lint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
      
      - name: Cache ruff
        uses: actions/cache@v5
        with:
          path: ~/.cache/ruff
          key: ruff-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
      
      - name: Ruff format check
        id: format
        run: |
          ruff format --check . 2>&1 | tee ruff-format.log
          echo "FORMAT_RESULT=$?" >> $GITHUB_ENV
      
      - name: Ruff lint
        id: lint
        run: |
          ruff check . 2>&1 | tee ruff-lint.log
          echo "LINT_RESULT=$?" >> $GITHUB_ENV
      
      - name: Generate summary
        if: always()
        run: |
          echo "##  Ruff Quality Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.FORMAT_RESULT }}" = "0" ]; then
            echo "| Format |  PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Format |  FAIL |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ env.LINT_RESULT }}" = "0" ]; then
            echo "| Lint |  PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Lint |  FAIL |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Python Version:** ${{ inputs.python-version }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ruff-logs-${{ github.sha }}
          path: |
            ruff-format.log
            ruff-lint.log
          retention-days: 7
      
      - name: Fail if checks failed
        if: env.FORMAT_RESULT != '0' || env.LINT_RESULT != '0'
        run: exit 1

  mypy:
    name: Mypy (Type Checking)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
      
      - name: Cache mypy
        uses: actions/cache@v5
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ inputs.python-version }}-${{ hashFiles('src/**/*.py', 'pyproject.toml') }}
      
      - name: Mypy type check
        id: mypy
        run: |
          if [ "${{ inputs.mypy-strict }}" = "true" ]; then
            mypy src --strict --config-file pyproject.toml 2>&1 | tee mypy.log
          else
            mypy src --config-file pyproject.toml 2>&1 | tee mypy.log
          fi
          echo "MYPY_RESULT=$?" >> $GITHUB_ENV
      
      - name: Generate summary
        if: always()
        run: |
          echo "##  Mypy Type Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.MYPY_RESULT }}" = "0" ]; then
            echo "| Status |  PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status |  FAIL |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Strict Mode | ${{ inputs.mypy-strict }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ inputs.python-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f mypy.log ]; then
            ERROR_COUNT=$(grep -c "error:" mypy.log || echo "0")
            echo "**Errors found:** $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-logs-${{ github.sha }}
          path: mypy.log
          retention-days: 7
      
      - name: Fail if check failed
        if: env.MYPY_RESULT != '0'
        run: exit 1

  pylint:
    name: Pylint (Code Quality)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
      
      - name: Pylint check
        id: pylint
        run: |
          pylint src/bnsyn --rcfile=pyproject.toml --fail-under=${{ inputs.pylint-threshold }} 2>&1 | tee pylint.log
          echo "PYLINT_RESULT=$?" >> $GITHUB_ENV
      
      - name: Generate summary
        if: always()
        run: |
          echo "##  Pylint Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.PYLINT_RESULT }}" = "0" ]; then
            echo "| Status |  PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status |  FAIL |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | ${{ inputs.pylint-threshold }}/10.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ inputs.python-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f pylint.log ]; then
            SCORE=$(grep "Your code has been rated at" pylint.log | sed 's/.*rated at \([0-9.]*\).*/\1/' || echo "N/A")
            echo "**Score:** $SCORE/10.0" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pylint-logs-${{ github.sha }}
          path: pylint.log
          retention-days: 7
      
      - name: Fail if check failed
        if: env.PYLINT_RESULT != '0'
        run: exit 1
