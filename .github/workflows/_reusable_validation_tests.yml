# REUSABLE NON-PR-GATE: long-running workflow_call; must not run on pull_request/push.
name: Reusable Validation Tests

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      markers:
        description: 'Pytest marker expression'
        type: string
        default: 'validation'
      extra-args:
        description: 'Extra pytest args'
        type: string
        default: '-v --tb=short'
      log-file:
        description: 'Log file path'
        type: string
        default: 'validation.log'
      junit-file:
        description: 'JUnit XML file path'
        type: string
        default: 'validation-junit.xml'
      junit-enabled:
        description: 'Enable JUnit XML output'
        type: boolean
        default: true
      summary-title:
        description: 'Summary title'
        type: string
        default: 'Validation Suite'
      upload-artifacts:
        description: 'Upload log artifacts'
        type: boolean
        default: false
      artifact-name:
        description: 'Artifact name'
        type: string
        default: 'validation-logs'
      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        default: 30

permissions:
  contents: read

jobs:
  validation-tests:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs['timeout-minutes'] }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs['python-version'] }}
          cache: 'pip'
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Install dependencies
        run: python -m pip install -e ".[dev,test]"
      - name: Run validation tests
        id: validation
        run: |
          set +e
          JUNIT_ARGS=""
          if [ "${{ inputs['junit-enabled'] }}" = "true" ]; then
            JUNIT_ARGS="--junit-xml=${{ inputs['junit-file'] }}"
          fi
          pytest -m "${{ inputs.markers }}" ${{ inputs['extra-args'] }} $JUNIT_ARGS 2>&1 | tee "${{ inputs['log-file'] }}"
          TEST_STATUS=${PIPESTATUS[0]}
          echo "TEST_STATUS=$TEST_STATUS" >> "$GITHUB_ENV"
          exit "$TEST_STATUS"
      - name: Generate summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  ${{ inputs['summary-title'] }}"
            echo ""
            echo "### Results"
            echo '```'
            tail -20 "${{ inputs['log-file'] }}" || true
            echo '```'
          } >> "$summary_file"
      - name: Upload logs
        if: inputs['upload-artifacts'] && always()
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs['artifact-name'] }}-${{ github.sha }}
          path: |
            ${{ inputs['log-file'] }}
            ${{ inputs['junit-file'] }}
          if-no-files-found: ignore
          retention-days: 30
