name: ci-benchmarks

on:
  pull_request:
  workflow_dispatch:
    inputs:
      tier:
        description: "Benchmark tier to run"
        required: true
        type: choice
        default: standard
        options:
          - standard
          - elite
      profile:
        description: "Benchmark profile to run"
        required: true
        type: choice
        default: baseline
        options:
          - micro
          - baseline
          - full
          - custom
      scenario:
        description: "Benchmark scenario to run (custom profile only)"
        required: false
        default: ci_smoke
        type: choice
        options:
          - ci_smoke
          - quick
          - n_sweep
          - steps_sweep
          - conn_sweep
          - dt_sweep
  workflow_call:
    inputs:
      tier:
        description: "Benchmark tier to run (standard|elite)"
        required: true
        type: string
      profile:
        description: "Benchmark profile to run (micro|baseline|full|custom)"
        required: true
        type: string
      scenario:
        description: "Benchmark scenario to run (custom profile only)"
        required: false
        type: string
        default: ci_smoke
    secrets:
      BENCHMARK_GPG_PASSPHRASE:
        required: false
      SLACK_WEBHOOK_URL:
        required: false
  schedule:
    - cron: '0 2 * * *'
    - cron: '0 3 * * 0'

permissions:
  contents: write
  actions: read
  checks: read
  statuses: read
  pull-requests: read
  security-events: write
  packages: read

jobs:
  benchmarks-pr:
    if: ${{ github.event_name == 'pull_request' }}
    uses: ./.github/workflows/_reusable_benchmarks.yml
    with:
      tier: standard
      profile: micro
      scenario: ci_smoke
    secrets: inherit

  benchmarks-dispatch:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    uses: ./.github/workflows/_reusable_benchmarks.yml
    with:
      tier: ${{ inputs.tier }}
      profile: ${{ inputs.profile }}
      scenario: ${{ inputs.scenario }}
    secrets: inherit

  benchmarks-call:
    if: ${{ github.event_name == 'workflow_call' }}
    uses: ./.github/workflows/_reusable_benchmarks.yml
    with:
      tier: ${{ inputs.tier }}
      profile: ${{ inputs.profile }}
      scenario: ${{ inputs.scenario }}
    secrets: inherit

  benchmarks-standard:
    if: ${{ github.event_name == 'schedule' && github.event.schedule == '0 2 * * *' }}
    uses: ./.github/workflows/_reusable_benchmarks.yml
    with:
      tier: standard
      profile: baseline
      scenario: ci_smoke
    secrets: inherit

  benchmarks-elite:
    if: ${{ github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0' }}
    uses: ./.github/workflows/_reusable_benchmarks.yml
    with:
      tier: elite
      profile: baseline
      scenario: ci_smoke
    secrets: inherit
