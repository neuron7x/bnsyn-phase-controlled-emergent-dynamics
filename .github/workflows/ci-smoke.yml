name: ci-smoke
# NON-PR-GATE: long-running workflow; must not run on pull_request/push.

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  contents: read

jobs:
  gate-profile:
    uses: ./.github/workflows/_reusable_gate_profile.yml
    with:
      profile: long

  ssot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Install dependencies
        run: python -m pip install -e ".[dev,test]"
      - name: SSOT gates
        run: |
          python -m scripts.validate_bibliography
          python -m scripts.validate_claims
          python -m scripts.scan_governed_docs
          python -m scripts.scan_normative_tags

  tests-smoke:
    needs: gate-profile
    uses: ./.github/workflows/_reusable_pytest.yml
    with:
      python-version: "3.11"
      markers: ${{ needs.gate-profile.outputs.pytest-markers }}
      coverage-threshold: ${{ fromJSON(needs.gate-profile.outputs.coverage-threshold) }}
      timeout-minutes: ${{ fromJSON(needs.gate-profile.outputs.pytest-timeout-minutes) }}
      upload-codecov: false
