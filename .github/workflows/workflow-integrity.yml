name: Workflow Integrity

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  validate-workflows:
    name: Validate workflow files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Enforce non-PR workflow triggers
        shell: bash
        run: |
          set -euo pipefail
          guard_line="# Guard: non-PR-gate workflow; must remain off PRs."
          mapfile -t files < <(
            grep -rlFx --include='*.yml' \
              -- "$guard_line" .github/workflows || true
          )
          if [ "${#files[@]}" -eq 0 ]; then
            echo "Guard line not found in any workflow."
            echo "Either add the guard line to intended non-PR workflows"
            echo "or remove this policy step."
            exit 1
          fi
          violations=0
          for file in "${files[@]}"; do
            awk '
              BEGIN { in_on=0; found=0 }

              /^on:[[:space:]]*\[/ {
                if ($0 ~ /pull_request/ || $0 ~ /push/ ||
                    $0 ~ /workflow_call/) {
                  print FILENAME ":" NR ":" $0
                  found=1
                }
                next
              }

              /^on:[[:space:]]*$/ { in_on=1; next }

              in_on {
                if ($0 ~ /^[^[:space:]]/) { exit }
                pattern = "^[[:space:]]*(pull_request|push|workflow_call)"
                pattern = pattern "[[:space:]]*:"
                if ($0 ~ pattern) {
                  print FILENAME ":" NR ":" $0
                  found=1
                }
              }

              END { if (found) exit 2 }
            ' "$file" || violations=1
          done
          if [ "$violations" -ne 0 ]; then
            echo "Non-PR workflow trigger violations detected."
            echo "Guarded workflows MUST NOT declare pull_request/push/"
            echo "workflow_call under on:."
            exit 1
          fi
          echo "Guarded workflows: trigger policy OK."
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Lint workflows with actionlint
        uses: rhysd/actionlint@v1.7.7
        with:
          args: -shellcheck=shellcheck -verbose
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Scan workflow files for tabs or non-ASCII
        shell: bash
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import unicodedata

          workflow_dir = Path('.github/workflows')
          offenders = []

          for path in sorted(workflow_dir.glob('*.yml')):
              text = path.read_text(encoding='utf-8', errors='replace')
              for line_no, line in enumerate(text.splitlines(), 1):
                  if '\t' in line:
                      offenders.append((path, line_no, 'TAB'))
                  for ch in line:
                      codepoint = ord(ch)
                      if codepoint > 0x7F:
                          detail = f'NON_ASCII U+{codepoint:04X}'
                          offenders.append((path, line_no, detail))
                      category = unicodedata.category(ch)
                      if category in {'Cf', 'Cc'} and ch not in {'\n', '\r'}:
                          detail = (
                              f'CONTROL_OR_BIDI {category} '
                              f'U+{codepoint:04X}'
                          )
                          offenders.append((path, line_no, detail))

          if offenders:
              for path, line_no, detail in offenders:
                  print(f'{path}:{line_no}:{detail}')
              raise SystemExit(1)

          print('Workflow integrity checks passed.')
          PY
      - name: Install safety checker dependencies
        run: python -m pip install pyyaml jsonschema
      - name: Validate safety artifacts
        run: python tools/safety/check_safety_artifacts.py
      - name: Validate inventory snapshot
        run: |
          python tools/generate_inventory.py
          git diff --exit-code -- INVENTORY.json
