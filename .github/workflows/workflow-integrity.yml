name: Workflow Integrity

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  validate-workflows:
    name: Validate workflow files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Enforce non-PR workflow triggers
        shell: bash
        run: |
          set -euo pipefail
          files=(
            ".github/workflows/benchmarks.yml"
            ".github/workflows/ci-benchmarks.yml"
            ".github/workflows/ci-benchmarks-elite.yml"
            ".github/workflows/ci-validation.yml"
            ".github/workflows/formal-coq.yml"
            ".github/workflows/formal-tla.yml"
            ".github/workflows/physics-equivalence.yml"
            ".github/workflows/science.yml"
          )
          violations=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing expected workflow file: $file"
              violations=1
              continue
            fi
            awk '
              /^on:/ {in_on=1; next}
              in_on {
                if ($0 ~ /^[^[:space:]]/) { exit }
                if ($0 ~ /^[[:space:]]*(pull_request|push|workflow_call):/) {
                  print FILENAME ":" NR ":" $0
                  found=1
                }
              }
              END { if (found) exit 2 }
            ' "$file" || violations=1
          done
          if [ "$violations" -ne 0 ]; then
            echo "Non-PR workflow trigger violations detected."
            echo "Remove pull_request/push/workflow_call from on: blocks."
            exit 1
          fi
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Lint workflows with actionlint
        uses: rhysd/actionlint@v1.7.7
        with:
          args: -shellcheck=shellcheck -verbose
      - name: Scan workflow files for tabs or non-ASCII
        shell: bash
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import unicodedata

          workflow_dir = Path('.github/workflows')
          offenders = []

          for path in sorted(workflow_dir.glob('*.yml')):
              text = path.read_text(encoding='utf-8', errors='replace')
              for line_no, line in enumerate(text.splitlines(), 1):
                  if '\t' in line:
                      offenders.append((path, line_no, 'TAB'))
                  for ch in line:
                      codepoint = ord(ch)
                      if codepoint > 0x7F:
                          detail = f'NON_ASCII U+{codepoint:04X}'
                          offenders.append((path, line_no, detail))
                      category = unicodedata.category(ch)
                      if category in {'Cf', 'Cc'} and ch not in {'\n', '\r'}:
                          detail = f'CONTROL_OR_BIDI {category} U+{codepoint:04X}'
                          offenders.append((path, line_no, detail))

          if offenders:
              for path, line_no, detail in offenders:
                  print(f'{path}:{line_no}:{detail}')
              raise SystemExit(1)

          print('Workflow integrity checks passed.')
          PY
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Install safety checker dependencies
        run: python -m pip install pyyaml jsonschema
      - name: Validate safety artifacts
        run: python tools/safety/check_safety_artifacts.py
