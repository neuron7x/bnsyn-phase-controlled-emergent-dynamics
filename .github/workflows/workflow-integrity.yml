name: Workflow Integrity

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  validate-workflows:
    name: Validate workflow files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Enforce non-PR workflow triggers
        shell: bash
        run: |
          set -euo pipefail
          allowlist=(
            "ci-pr-atomic.yml"
            "ci-pr.yml"
            "ci-smoke.yml"
            "codeql.yml"
            "docs.yml"
            "workflow-integrity.yml"
            "_reusable_benchmarks.yml"
            "_reusable_chaos_tests.yml"
            "_reusable_formal_science.yml"
            "_reusable_property_tests.yml"
            "_reusable_pytest.yml"
            "_reusable_quality.yml"
            "_reusable_ssot.yml"
            "_reusable_validation_tests.yml"
          )
          declare -A allowed
          for name in "${allowlist[@]}"; do
            allowed["$name"]=1
          done
          mapfile -t files < <(ls .github/workflows/*.yml)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No workflow files found."
            exit 1
          fi
          echo "Scanned ${#files[@]} workflows."
          echo "Allowed PR-trigger workflows: ${allowlist[*]}"
          violations=0
          for file in "${files[@]}"; do
            base="$(basename "$file")"
            is_allowed="${allowed[$base]-}"
            status=0
            if ! awk '
              BEGIN { in_on=0; found=0 }

              /^on:[[:space:]]*\[/ {
                if ($0 ~ /pull_request/ || $0 ~ /push/ ||
                    $0 ~ /workflow_call/) {
                  print FILENAME ":" NR ":" $0
                  found=1
                }
                next
              }

              /^on:[[:space:]]*(pull_request|push|workflow_call)[[:space:]]*$/ {
                print FILENAME ":" NR ":" $0
                found=1
                next
              }

              /^on:[[:space:]]*$/ { in_on=1; next }

              in_on {
                if ($0 ~ /^[^[:space:]]/) { exit }
                pattern = "^[[:space:]]*(pull_request|push|workflow_call)"
                pattern = pattern "[[:space:]]*:"
                if ($0 ~ pattern) {
                  print FILENAME ":" NR ":" $0
                  found=1
                }
              }

              END { if (found) exit 2 }
            ' "$file"; then
              status=$?
            fi
            if [ "$status" -eq 2 ]; then
              if [ -z "$is_allowed" ]; then
                violations=1
              fi
            elif [ "$status" -ne 0 ]; then
              violations=1
            fi
          done
          if [ "$violations" -ne 0 ]; then
            echo "Non-PR workflow trigger violations detected."
            echo "Workflows outside the allowlist MUST NOT declare"
            echo "pull_request/push/workflow_call under on:."
            exit 1
          fi
          echo "Guarded workflows: trigger policy OK."
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      - name: Lint workflows with actionlint
        uses: rhysd/actionlint@v1.7.7
        with:
          args: -shellcheck=shellcheck -verbose
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Scan workflow files for tabs or non-ASCII
        shell: bash
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import unicodedata

          workflow_dir = Path(".github/workflows")
          md_files = sorted(Path(".github").rglob("*.md"))
          offenders = []

          def scan_text(
              path: Path,
              allow_non_ascii: bool,
          ) -> None:
              text = path.read_text(encoding="utf-8", errors="replace")
              for line_no, line in enumerate(text.splitlines(), 1):
                  if "\t" in line:
                      offenders.append((path, line_no, "TAB"))
                  for ch in line:
                      codepoint = ord(ch)
                      category = unicodedata.category(ch)
                      if category in {"Cf", "Cc"} and ch not in {"\n", "\r"}:
                          detail = (
                              f"CONTROL_OR_BIDI {category} "
                              f"U+{codepoint:04X}"
                          )
                          offenders.append((path, line_no, detail))
                      if not allow_non_ascii and codepoint > 0x7F:
                          detail = f"NON_ASCII U+{codepoint:04X}"
                          offenders.append((path, line_no, detail))

          for path in sorted(workflow_dir.glob("*.yml")):
              scan_text(path, allow_non_ascii=False)

          for path in md_files:
              scan_text(path, allow_non_ascii=True)

          if offenders:
              for path, line_no, detail in offenders:
                  print(f"{path}:{line_no}:{detail}")
              raise SystemExit(1)

          print("Workflow integrity checks passed.")
          PY
      - name: Install safety checker dependencies
        run: python -m pip install pyyaml jsonschema
      - name: Verify Required PR Gates list
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import re

          import yaml

          contracts_path = Path(".github/WORKFLOW_CONTRACTS.md")
          workflows_path = Path(".github/workflows")

          text = contracts_path.read_text(encoding="utf-8")
          section_match = re.search(
              r"^## Required PR Gates$",
              text,
              flags=re.MULTILINE,
          )
          if not section_match:
              raise SystemExit("Required PR Gates section not found.")

          lines = text[section_match.end():].splitlines()
          table_lines: list[str] = []
          for line in lines:
              if line.startswith("## "):
                  break
              if line.strip():
                  table_lines.append(line)

          expected: dict[str, dict[str, object]] = {}
          for line in table_lines:
              if not line.strip().startswith("|"):
                  continue
              cells = [cell.strip() for cell in line.strip().strip("|").split("|")]
              if len(cells) != 3:
                  continue
              if cells[0].startswith("---"):
                  continue
              if cells[0] == "Workflow File":
                  continue
              workflow_file = cells[0].strip("` ")
              workflow_name = cells[1].strip("` ")
              jobs_raw = cells[2]
              jobs = [
                  job.strip("` ").strip()
                  for job in jobs_raw.split(",")
                  if job.strip()
              ]
              expected[workflow_file] = {
                  "name": workflow_name,
                  "jobs": sorted(jobs),
              }

          if not expected:
              raise SystemExit("No Required PR Gates entries found.")

          actual: dict[str, dict[str, object]] = {}
          for workflow in sorted(workflows_path.glob("*.yml")):
              data = yaml.safe_load(workflow.read_text(encoding="utf-8"))
              if not data:
                  continue
              on_section = data.get("on", {})
              has_pr = False
              if isinstance(on_section, list):
                  has_pr = "pull_request" in on_section
              elif isinstance(on_section, str):
                  has_pr = on_section == "pull_request"
              elif isinstance(on_section, dict):
                  has_pr = "pull_request" in on_section
              if not has_pr:
                  continue
              jobs = sorted((data.get("jobs") or {}).keys())
              actual[workflow.name] = {
                  "name": str(data.get("name", workflow.stem)),
                  "jobs": jobs,
              }

          expected_keys = set(expected.keys())
          actual_keys = set(actual.keys())
          if expected_keys != actual_keys:
              missing = sorted(actual_keys - expected_keys)
              extra = sorted(expected_keys - actual_keys)
              if missing:
                  print(f"Missing Required PR Gates entries: {missing}")
              if extra:
                  print(f"Extra Required PR Gates entries: {extra}")
              raise SystemExit(1)

          mismatches = []
          for workflow_file in sorted(expected_keys):
              exp = expected[workflow_file]
              act = actual[workflow_file]
              if exp["name"] != act["name"]:
                  mismatches.append(
                      f"{workflow_file}: name mismatch "
                      f"(expected {exp['name']}, actual {act['name']})"
                  )
              if exp["jobs"] != act["jobs"]:
                  mismatches.append(
                      f"{workflow_file}: job list mismatch "
                      f"(expected {exp['jobs']}, actual {act['jobs']})"
                  )
          if mismatches:
              for mismatch in mismatches:
                  print(mismatch)
              raise SystemExit(1)

          print("Required PR Gates list matches PR-triggered workflows.")
          PY
      - name: Validate safety artifacts
        run: python tools/safety/check_safety_artifacts.py
      - name: Validate inventory snapshot
        run: |
          python tools/generate_inventory.py
          git diff --exit-code -- INVENTORY.json
