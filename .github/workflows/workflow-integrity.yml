name: Workflow Integrity

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  validate-workflows:
    name: Validate workflow files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Scan workflow files for ASCII and bidi controls
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path

          workflow_dir = Path('.github/workflows')
          paths = sorted({*workflow_dir.rglob('*.yml'), *workflow_dir.rglob('*.yaml')})

          allowed_bytes = {9, 10, 13, *range(0x20, 0x7F)}
          banned_codepoints = {
              0x202A,
              0x202B,
              0x202C,
              0x202D,
              0x202E,
              0x2066,
              0x2067,
              0x2068,
              0x2069,
              0x200E,
              0x200F,
              0xFEFF,
          }

          violations: list[str] = []

          for path in paths:
              data = path.read_bytes()
              for offset, byte in enumerate(data):
                  if byte not in allowed_bytes:
                      violations.append(
                          f"{path}:byte_offset={offset}:NON_ASCII_BYTE=0x{byte:02X}"
                      )
              try:
                  text = data.decode('utf-8')
              except UnicodeDecodeError as exc:
                  violations.append(
                      f"{path}:byte_offset={exc.start}:INVALID_UTF8"
                  )
                  continue
              byte_offset = 0
              for ch in text:
                  codepoint = ord(ch)
                  if codepoint in banned_codepoints:
                      violations.append(
                          f"{path}:byte_offset={byte_offset}:BIDI_CONTROL=U+{codepoint:04X}"
                      )
                  byte_offset += len(ch.encode('utf-8'))

          if violations:
              for violation in violations:
                  print(violation)
              raise SystemExit(1)

          print('Workflow integrity checks passed.')
          PY
      - name: Install actionlint
        shell: bash
        run: |
          set -euo pipefail
          version="1.7.1"
          arch="$(uname -m)"
          case "$arch" in
            x86_64) arch="amd64" ;;
            aarch64|arm64) arch="arm64" ;;
            *) echo "Unsupported arch: $arch"; exit 1 ;;
          esac
          os="linux"
          url="https://github.com/rhysd/actionlint/releases/download/v${version}/actionlint_${version}_${os}_${arch}.tar.gz"
          curl -sSfL "$url" -o actionlint.tar.gz
          tar -xzf actionlint.tar.gz actionlint
          ./actionlint -version
      - name: Run actionlint
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t workflow_files < <(find .github/workflows -type f \( -name '*.yml' -o -name '*.yaml' \) | sort)
          if [ "${#workflow_files[@]}" -eq 0 ]; then
            echo "No workflow files found."
            exit 1
          fi
          ./actionlint -color -verbose -shellcheck= "${workflow_files[@]}"
