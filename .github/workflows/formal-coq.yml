name: formal-coq

on:
  schedule:
    # Run nightly at 1 AM UTC
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: formal-coq-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coq-proof-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up OCaml and Coq
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: "4.14.x"
          dune-cache: true
          opam-pin: false
          opam-depext: true
      
      - name: Install Coq
        run: |
          opam install -y coq.8.18.0
          opam install -y coq-mathcomp-ssreflect.2.2.0
          eval "$(opam env)"
      
      - name: Verify Coq installation
        run: |
          eval "$(opam env)"
          coqc --version | tee coq_version.txt
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "Coq installed: $(cat coq_version.txt)"
          } >> "$summary_file"
      
      - name: Compile Coq proofs
        id: coq_compile
        run: |
          eval "$(opam env)"
          cd specs/coq
          
          # Compile all .v files
          COMPILATION_FAILED=0
          summary_lines="##  Coq Proof Verification\n\n"
          for vfile in *.v; do
            if [ -f "$vfile" ]; then
              echo "Compiling $vfile..." | tee -a coq_compile_log.txt
              if coqc "$vfile" 2>&1 | tee "coq_output_${vfile%.v}.txt"; then
                summary_lines="${summary_lines} $vfile compiled successfully\n"
              else
                summary_lines="${summary_lines} $vfile compilation failed\n"
                COMPILATION_FAILED=1
              fi
            fi
          done
          
          if [ "$COMPILATION_FAILED" -eq 1 ]; then
            summary_lines="${summary_lines}\n Some Coq proofs failed to compile\n"
            summary_file="$GITHUB_STEP_SUMMARY"
            printf '%b' "$summary_lines" >> "$summary_file"
            exit 1
          else
            summary_lines="${summary_lines}\n All Coq proofs verified successfully\n"
            summary_file="$GITHUB_STEP_SUMMARY"
            printf '%b' "$summary_lines" >> "$summary_file"
          fi
      
      - name: Generate proof summary
        if: always()
        run: |
          eval "$(opam env)"
          cd specs/coq
          
          cat > coq_summary.md << EOF
          # Coq Proof Verification Summary
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Coq Version:** $(coqc --version | head -1)
          
          ## Verified Proofs
          
          EOF
          
          for vfile in *.v; do
            if [ -f "$vfile" ]; then
              echo "- **$vfile**" >> coq_summary.md
              if [ -f "coq_output_${vfile%.v}.txt" ]; then
                grep -E "(Theorem|Lemma|Corollary|Definition)" "coq_output_${vfile%.v}.txt" || echo "  (compiled successfully)" >> coq_summary.md
              fi
            fi
          done
      
      - name: Upload Coq artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coq-proof-verification-${{ github.sha }}
          path: |
            specs/coq/coq_output_*.txt
            specs/coq/coq_summary.md
            specs/coq/*.vo
            specs/coq/*.glob
          retention-days: 30
      
      - name: Check compilation status
        if: always()
        run: |
          if [ "${{ steps.coq_compile.outcome }}" != "success" ]; then
            summary_file="$GITHUB_STEP_SUMMARY"
            {
              echo " Coq proof verification failed"
            } >> "$summary_file"
            exit 1
          fi
