name: formal-tla

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      max_steps:
        description: 'Maximum steps for model checking'
        required: false
        default: '100'

permissions:
  contents: read

concurrency:
  group: formal-tla-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tla-model-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      TLA2TOOLS_VERSION: "1.8.0"
      TLA2TOOLS_SHA256: "a6ece2e543c87e6e7d90d1c6e0cc04d57b1f08e6e7f4f4db08ebafdd8b39c53e"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download and verify TLA+ Tools
        run: |
          cd specs/tla
          wget -q "https://github.com/tlaplus/tlaplus/releases/download/v${TLA2TOOLS_VERSION}/tla2tools.jar"
          
          # Verify SHA256
          echo "${TLA2TOOLS_SHA256}  tla2tools.jar" | sha256sum -c - || {
            echo " SHA256 verification failed for tla2tools.jar"
            exit 1
          }
          
          echo " TLA+ tools v${TLA2TOOLS_VERSION} downloaded and verified"
      
      - name: Generate TLA+ configuration with max_steps
        run: |
          cd specs/tla
          MAX_STEPS="${{ github.event.inputs.max_steps || '100' }}"
          
          # Generate config with dynamic MaxSteps
          cat > BNsyn_runtime.cfg << EOF
          SPECIFICATION Spec
          
          \* Constants configuration (aligned with src/bnsyn/config.py)
          CONSTANTS
              T0 = 1.0
              Tmin = 0.001
              Alpha = 0.95
              Tc = 0.1
              GateTau = 0.02
              GainMin = 0.2
              GainMax = 5.0
              MaxSteps = ${MAX_STEPS}
          
          \* State invariants to check (no primed variables)
          INVARIANTS
              TypeOK
              GainClamp
              TemperatureBounds
              GateBounds
              PhaseValid
          
          \* Temporal properties to check
          PROPERTIES
              TemperatureMonotone
              EventuallyCooled
              GateCorrelation
          
          \* Constraints for model checking
          CONSTRAINT step <= MaxSteps
          EOF
          
          echo "Generated BNsyn_runtime.cfg with MaxSteps=${MAX_STEPS}"
      
      - name: Verify TLA+ specification syntax
        id: syntax
        run: |
          cd specs/tla
          # Parse the specification to check for syntax errors
          java -cp tla2tools.jar tla2sany.SANY BNsyn.tla
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo " TLA+ specification syntax is valid"
          } >> "$summary_file"
      
      - name: Run TLC model checker
        id: tlc
        run: |
          cd specs/tla
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  TLA+ Model Checking Results"
            echo ""
          } >> "$summary_file"
          
          # Run TLC with runtime configuration
          java -XX:+UseParallelGC -Xmx4g -jar tla2tools.jar \
            -config BNsyn_runtime.cfg \
            -workers auto \
            -coverage 1 \
            BNsyn.tla 2>&1 | tee tlc_output.txt
      
      - name: Analyze TLC results
        if: always()
        run: |
          cd specs/tla
          
          # Determine overall status
          if grep -q "Model checking completed. No error has been found." tlc_output.txt; then
            STATUS="PASS"
            SUMMARY_LINES=" **Model checking PASSED**\n\nAll invariants verified successfully.\n"
          elif grep -q "Error:" tlc_output.txt; then
            STATUS="FAIL"
            SUMMARY_LINES=" **Model checking FAILED**\n\nInvariant violations detected!\n"
          else
            STATUS="INCOMPLETE"
            SUMMARY_LINES=" **Model checking INCOMPLETE**\n\nModel checker did not complete successfully.\n"
          fi
          echo "STATUS=$STATUS" >> "$GITHUB_ENV"
          summary_file="$GITHUB_STEP_SUMMARY"
          printf '%b' "$SUMMARY_LINES" >> "$summary_file"
      
      - name: Extract model checking statistics
        if: always()
        run: |
          cd specs/tla
          
          # Extract key statistics
          if [ -f tlc_output.txt ]; then
            STATES=$(grep "distinct states" tlc_output.txt | tail -1 || echo "N/A")
            DIAMETER=$(grep "diameter" tlc_output.txt | tail -1 || echo "N/A")
            summary_lines="\n### Model Checking Statistics\n\n"
            summary_lines="${summary_lines}| Metric | Value |\n"
            summary_lines="${summary_lines}|--------|-------|\n"
            summary_lines="${summary_lines}| States Checked | $STATES |\n"
            summary_lines="${summary_lines}| State Graph Diameter | $DIAMETER |\n"
            summary_lines="${summary_lines}| Max Steps | ${{ github.event.inputs.max_steps || '100' }} |\n"
            summary_file="$GITHUB_STEP_SUMMARY"
            printf '%b' "$summary_lines" >> "$summary_file"
          fi
      
      - name: Generate detailed invariant report
        if: always()
        run: |
          cd specs/tla
          
          summary_lines="\n### Invariant Verification Status\n\n"
          summary_lines="${summary_lines}| Invariant | Status |\n"
          summary_lines="${summary_lines}|-----------|--------|\n"
          # Check each invariant individually with proper status
          for inv in "TypeOK" "GainClamp" "TemperatureBounds" "GateBounds" "PhaseValid"; do
            if grep -q "Invariant $inv is violated" tlc_output.txt 2>/dev/null; then
              summary_lines="${summary_lines}| $inv |  VIOLATED |\n"
            elif grep -q "Model checking completed. No error has been found." tlc_output.txt 2>/dev/null; then
              summary_lines="${summary_lines}| $inv |  VERIFIED |\n"
            elif grep -q "Finished computing initial states" tlc_output.txt 2>/dev/null; then
              # TLC started but didn't complete
              summary_lines="${summary_lines}| $inv |  NOT_PROVEN |\n"
            else
              # TLC didn't run properly
              summary_lines="${summary_lines}| $inv |  NOT_CHECKED |\n"
            fi
          done
          summary_file="$GITHUB_STEP_SUMMARY"
          printf '%b' "$summary_lines" >> "$summary_file"
      
      - name: Create summary report file
        if: always()
        run: |
          cd specs/tla
          
          cat > tla_summary.md << EOF
          # TLA+ Model Checking Summary
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Version:** ${TLA2TOOLS_VERSION}
          **MaxSteps:** ${{ github.event.inputs.max_steps || '100' }}
          **Status:** ${STATUS}
          
          ## Output
          \`\`\`
          $(cat tlc_output.txt)
          \`\`\`
          EOF
      
      - name: Upload TLC artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tla-model-check-report-${{ github.sha }}
          path: |
            specs/tla/tlc_output.txt
            specs/tla/tla_summary.md
            specs/tla/BNsyn_runtime.cfg
            specs/tla/*.out
          retention-days: 30
      
      - name: Check for violations and fail if needed
        if: always()
        run: |
          cd specs/tla
          
          if [ "${STATUS}" = "FAIL" ]; then
            summary_file="$GITHUB_STEP_SUMMARY"
            {
              echo ""
              echo "###  Violation Details"
              echo ""
              echo '```'
              grep -A 20 "Error:" tlc_output.txt || true
              echo '```'
          } >> "$summary_file"
            exit 1
          elif [ "${STATUS}" = "INCOMPLETE" ]; then
            summary_file="$GITHUB_STEP_SUMMARY"
            {
              echo " Model checking incomplete - check artifacts"
            } >> "$summary_file"
            exit 1
          fi
