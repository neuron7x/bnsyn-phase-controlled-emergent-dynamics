name: formal-tla

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      max_steps:
        description: 'Maximum steps for model checking'
        required: false
        default: '100'

permissions:
  contents: read

concurrency:
  group: formal-tla-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tla-model-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      TLA2TOOLS_VERSION: "1.8.0"
      TLA2TOOLS_SHA256: "a6ece2e543c87e6e7d90d1c6e0cc04d57b1f08e6e7f4f4db08ebafdd8b39c53e"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download and verify TLA+ Tools
        run: |
          cd specs/tla
          wget -q "https://github.com/tlaplus/tlaplus/releases/download/v${TLA2TOOLS_VERSION}/tla2tools.jar"
          
          # Verify SHA256
          echo "${TLA2TOOLS_SHA256}  tla2tools.jar" | sha256sum -c - || {
            echo " SHA256 verification failed for tla2tools.jar"
            exit 1
          }
          
          echo " TLA+ tools v${TLA2TOOLS_VERSION} downloaded and verified"
      
      - name: Generate TLA+ configuration with max_steps
        run: |
          cd specs/tla
          MAX_STEPS="${{ github.event.inputs.max_steps || '100' }}"
          
          # Generate config with dynamic MaxSteps
          cat > BNsyn_runtime.cfg << EOF
          SPECIFICATION Spec
          
          \* Constants configuration (aligned with src/bnsyn/config.py)
          CONSTANTS
              T0 = 1.0
              Tmin = 0.001
              Alpha = 0.95
              Tc = 0.1
              GateTau = 0.02
              GainMin = 0.2
              GainMax = 5.0
              MaxSteps = ${MAX_STEPS}
          
          \* State invariants to check (no primed variables)
          INVARIANTS
              TypeOK
              GainClamp
              TemperatureBounds
              GateBounds
              PhaseValid
          
          \* Temporal properties to check
          PROPERTIES
              TemperatureMonotone
              EventuallyCooled
              GateCorrelation
          
          \* Constraints for model checking
          CONSTRAINT step <= MaxSteps
          EOF
          
          echo "Generated BNsyn_runtime.cfg with MaxSteps=${MAX_STEPS}"
      
      - name: Verify TLA+ specification syntax
        id: syntax
        run: |
          cd specs/tla
          # Parse the specification to check for syntax errors
          java -cp tla2tools.jar tla2sany.SANY BNsyn.tla
          echo " TLA+ specification syntax is valid" >> $GITHUB_STEP_SUMMARY
      
      - name: Run TLC model checker
        id: tlc
        run: |
          cd specs/tla
          
          echo "##  TLA+ Model Checking Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run TLC with runtime configuration
          java -XX:+UseParallelGC -Xmx4g -jar tla2tools.jar \
            -config BNsyn_runtime.cfg \
            -workers auto \
            -coverage 1 \
            BNsyn.tla 2>&1 | tee tlc_output.txt
      
      - name: Analyze TLC results
        if: always()
        run: |
          cd specs/tla
          
          # Determine overall status
          if grep -q "Model checking completed. No error has been found." tlc_output.txt; then
            echo "STATUS=PASS" >> $GITHUB_ENV
            echo " **Model checking PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All invariants verified successfully." >> $GITHUB_STEP_SUMMARY
          elif grep -q "Error:" tlc_output.txt; then
            echo "STATUS=FAIL" >> $GITHUB_ENV
            echo " **Model checking FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Invariant violations detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "STATUS=INCOMPLETE" >> $GITHUB_ENV
            echo " **Model checking INCOMPLETE**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Model checker did not complete successfully." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Extract model checking statistics
        if: always()
        run: |
          cd specs/tla
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Model Checking Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract key statistics
          if [ -f tlc_output.txt ]; then
            STATES=$(grep "distinct states" tlc_output.txt | tail -1 || echo "N/A")
            DIAMETER=$(grep "diameter" tlc_output.txt | tail -1 || echo "N/A")
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| States Checked | $STATES |" >> $GITHUB_STEP_SUMMARY
            echo "| State Graph Diameter | $DIAMETER |" >> $GITHUB_STEP_SUMMARY
            echo "| Max Steps | ${{ github.event.inputs.max_steps || '100' }} |" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Generate detailed invariant report
        if: always()
        run: |
          cd specs/tla
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Invariant Verification Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Invariant | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check each invariant individually with proper status
          for inv in "TypeOK" "GainClamp" "TemperatureBounds" "GateBounds" "PhaseValid"; do
            if grep -q "Invariant $inv is violated" tlc_output.txt 2>/dev/null; then
              echo "| $inv |  VIOLATED |" >> $GITHUB_STEP_SUMMARY
            elif grep -q "Model checking completed. No error has been found." tlc_output.txt 2>/dev/null; then
              echo "| $inv |  VERIFIED |" >> $GITHUB_STEP_SUMMARY
            elif grep -q "Finished computing initial states" tlc_output.txt 2>/dev/null; then
              # TLC started but didn't complete
              echo "| $inv |  NOT_PROVEN |" >> $GITHUB_STEP_SUMMARY
            else
              # TLC didn't run properly
              echo "| $inv |  NOT_CHECKED |" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: Create summary report file
        if: always()
        run: |
          cd specs/tla
          
          cat > tla_summary.md << EOF
          # TLA+ Model Checking Summary
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Version:** ${TLA2TOOLS_VERSION}
          **MaxSteps:** ${{ github.event.inputs.max_steps || '100' }}
          **Status:** ${STATUS}
          
          ## Output
          \`\`\`
          $(cat tlc_output.txt)
          \`\`\`
          EOF
      
      - name: Upload TLC artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tla-model-check-report-${{ github.sha }}
          path: |
            specs/tla/tlc_output.txt
            specs/tla/tla_summary.md
            specs/tla/BNsyn_runtime.cfg
            specs/tla/*.out
          retention-days: 30
      
      - name: Check for violations and fail if needed
        if: always()
        run: |
          cd specs/tla
          
          if [ "${STATUS}" = "FAIL" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "###  Violation Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 20 "Error:" tlc_output.txt >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${STATUS}" = "INCOMPLETE" ]; then
            echo " Model checking incomplete - check artifacts" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
