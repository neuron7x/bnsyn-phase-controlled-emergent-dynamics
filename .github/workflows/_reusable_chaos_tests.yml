name: Reusable Chaos Tests

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
      test-subset:
        description: 'Chaos test subset'
        type: string
        default: 'all'
      timeout-minutes:
        description: 'Job timeout in minutes'
        type: number
        default: 60
      upload-artifacts:
        description: 'Upload log artifacts'
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  chaos-tests:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs['timeout-minutes'] }}
    strategy:
      fail-fast: false
      matrix:
        fault-type: ${{ inputs['test-subset'] == 'all' && fromJSON('["numeric", "timing", "stochastic", "io"]') || inputs['test-subset'] == 'numeric' && fromJSON('["numeric"]') || inputs['test-subset'] == 'timing' && fromJSON('["timing"]') || inputs['test-subset'] == 'stochastic' && fromJSON('["stochastic"]') || inputs['test-subset'] == 'io' && fromJSON('["io"]') || fromJSON('["numeric", "timing", "stochastic", "io"]') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs['python-version'] }}
          cache: 'pip'
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - name: Install dependencies
        run: python -m pip install -e ".[dev,test]"
      - name: Run chaos tests for ${{ matrix.fault-type }}
        id: chaos_test
        run: |
          set +e
          pytest tests/validation/test_chaos_${{ matrix.fault-type }}.py \
            -v \
            --tb=short \
            --strict-markers \
            -m "validation and chaos" \
            2>&1 | tee chaos_output_${{ matrix.fault-type }}.txt
          TEST_STATUS=${PIPESTATUS[0]}
          TOTAL=$(grep -E "passed|failed" chaos_output_${{ matrix.fault-type }}.txt | tail -1 || echo "0")
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Chaos Engineering: ${{ matrix.fault-type }} faults"
            echo ""
            echo "| Result | $TOTAL |"
          } >> "$summary_file"
          exit "$TEST_STATUS"
      - name: Upload chaos test results
        if: inputs['upload-artifacts'] && always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-results-${{ matrix.fault-type }}-${{ github.sha }}
          path: chaos_output_${{ matrix.fault-type }}.txt
          if-no-files-found: ignore
          retention-days: 30
