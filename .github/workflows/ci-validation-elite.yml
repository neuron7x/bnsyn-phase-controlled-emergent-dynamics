name: ci-validation-elite

on:
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Manual trigger for on-demand validation runs

concurrency:
  group: ci-validation-elite-${{ github.ref }}
  cancel-in-progress: false  # Let validation complete

jobs:
  validation:
    name: Scientific Validation Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          
      - name: Run validation tests
        id: validation
        run: |
          echo "## ðŸ”¬ Scientific Validation Suite" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running 10 validation tests to verify empirical claims..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          pytest -m validation -v --tb=short --junit-xml=validation-junit.xml > validation.log 2>&1 || true
          
          # Show summary
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 validation.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
      - name: Upload validation logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-logs-${{ github.sha }}
          path: |
            validation.log
            validation-junit.xml
          retention-days: 30
          
  property-tests:
    name: Property-Based Tests (Hypothesis)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          
      - name: Run property tests
        id: property
        env:
          HYPOTHESIS_PROFILE: ci-quick
        run: |
          echo "## ðŸ” Property-Based Invariants (Hypothesis)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running 8 property tests with 50 examples each..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          pytest -m property -v --tb=short --junit-xml=property-junit.xml > property.log 2>&1 || true
          
          # Show summary
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 property.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
      - name: Upload property test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: property-logs-${{ github.sha }}
          path: |
            property.log
            property-junit.xml
          retention-days: 30
          
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [validation, property-tests]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“Š Validation Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation Tests | ${{ needs.validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Property Tests | ${{ needs.property-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **Note:** This workflow is NON-BLOCKING and does not affect PR merge status." >> $GITHUB_STEP_SUMMARY
          echo "It runs on a schedule to verify scientific claims and system invariants." >> $GITHUB_STEP_SUMMARY
