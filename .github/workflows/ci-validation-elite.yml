name: ci-validation-elite

on:
  schedule:
    # Daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Manual trigger for on-demand validation runs

permissions:
  contents: read

concurrency:
  group: ci-validation-elite-${{ github.ref }}
  cancel-in-progress: false  # Let validation complete

jobs:
  validation:
    name: Scientific Validation Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
          
      - name: Run validation tests
        id: validation
        run: |
          pytest -m validation -v --tb=short --junit-xml=validation-junit.xml 2>&1 | tee validation.log
          
          # Show summary
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Scientific Validation Suite"
            echo ""
            echo "### Results"
            echo '```'
            tail -20 validation.log
            echo '```'
          } >> "$summary_file"
          
      - name: Upload validation logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-logs-${{ github.sha }}
          path: |
            validation.log
            validation-junit.xml
          retention-days: 30
          
  property-tests:
    name: Property-Based Tests (Hypothesis)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
          
      - name: Run property tests
        id: property
        env:
          HYPOTHESIS_PROFILE: quick
        run: |
          pytest -m property -v --tb=short --hypothesis-show-statistics --junit-xml=property-junit.xml 2>&1 | tee property.log
          
          # Show summary
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Property-Based Invariants (Hypothesis)"
            echo ""
            echo "### Results"
            echo '```'
            tail -20 property.log
            echo '```'
          } >> "$summary_file"
          
      - name: Upload property test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: property-logs-${{ github.sha }}
          path: |
            property.log
            property-junit.xml
          retention-days: 30
          
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [validation, property-tests]
    if: always()
    
    steps:
      - name: Summary
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Validation Suite Summary"
            echo ""
            echo "| Suite | Status |"
            echo "|-------|--------|"
            echo "| Validation Tests | ${{ needs.validation.result }} |"
            echo "| Property Tests | ${{ needs.property-tests.result }} |"
            echo ""
            echo " **Note:** This workflow is NON-BLOCKING and does not affect PR merge status."
            echo "It runs on a schedule to verify scientific claims and system invariants."
          } >> "$summary_file"
