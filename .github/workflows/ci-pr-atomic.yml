name: ci-pr-atomic

on:
  pull_request:
  push:
    branches: [main]

env:
  PIP_CACHE_DIR: ~/.cache/pip
  PYTHONHASHSEED: 0
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  determinism:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]"
      - name: Test determinism (run 1)
        run: pytest tests/test_determinism.py tests/test_properties_determinism.py -v --tb=short
      - name: Test determinism (run 2)
        run: pytest tests/test_determinism.py tests/test_properties_determinism.py -v --tb=short
      - name: Test determinism (run 3)
        run: pytest tests/test_determinism.py tests/test_properties_determinism.py -v --tb=short
      - name: Check RNG isolation
        run: pytest tests/test_determinism.py::test_no_global_numpy_rng_usage -v

  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]"
      - run: ruff format --check .
      - run: ruff check . --config pyproject.toml
      - run: mypy src --strict --config-file pyproject.toml
      - run: pylint src/bnsyn --rcfile=pyproject.toml --fail-under=7.5

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]" build
      - run: python -m build
      - run: python -c "import bnsyn; print(bnsyn.__version__)"

  tests-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]"
      - run: |
          pytest \
            -m "not validation" \
            --cov=src/bnsyn \
            --cov-report=term-missing:skip-covered \
            --cov-report=json \
            --cov-report=html \
            --cov-fail-under=85 \
            -v
        timeout-minutes: 10
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.json
          fail_ci_if_error: true
          verbose: true
          flags: smoke-tests
          name: smoke-coverage-${{ github.sha }}
        timeout-minutes: 5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Upload coverage artifact (fallback)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-failed-${{ github.sha }}
          path: |
            coverage.json
            htmlcov/
          retention-days: 7
      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-report-${{ github.sha }}
          path: htmlcov/
          retention-days: 30

  ssot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]"
      - run: python scripts/validate_bibliography.py
      - run: python scripts/validate_claims.py
      - run: python scripts/scan_normative_tags.py

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - run: pip install -e ".[dev]"
      - name: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
      - name: pip-audit
        run: pip-audit --desc --format json --output pip-audit-report.json
      - name: bandit
        run: bandit -r src/ -ll
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ github.sha }}
          path: pip-audit-report.json
          retention-days: 30

  finalize:
    runs-on: ubuntu-latest
    needs: [determinism, quality, build, tests-smoke, ssot, security]
    if: success()
    steps:
      - name: PR Quality Gate
        run: |
          echo "âœ… All PR checks passed!"
          echo "  âœ“ Determinism verified"
          echo "  âœ“ Code quality approved"
          echo "  âœ“ Build successful"
          echo "  âœ“ Tests passed (â‰¥85% coverage)"
          echo "  âœ“ SSOT gates verified"
          echo "  âœ“ Security audit passed"
          echo ""
          echo "Ready for merge ðŸš€"
