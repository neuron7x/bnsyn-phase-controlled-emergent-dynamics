name: ci-pr-atomic

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      python-version:
        type: string
        default: "3.11"
      upload-codecov:
        type: boolean
        default: true
  workflow_call:
    inputs:
      python-version:
        type: string
        default: "3.11"
      upload-codecov:
        type: boolean
        default: true
    secrets:
      CODECOV_TOKEN:
        required: false

permissions:
  contents: read

concurrency:
  group: ci-pr-atomic-${{ github.ref }}
  cancel-in-progress: true

env:
  PIP_CACHE_DIR: ~/.cache/pip
  PYTHONHASHSEED: 0
  PYTHONDONTWRITEBYTECODE: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1
  PIP_NO_PYTHON_VERSION_WARNING: 1

jobs:
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: read
    outputs:
      code: ${{ steps.filter.outputs.code }}
      code_changed: ${{ steps.filter.outputs.code_changed }}
      tests_changed: ${{ steps.filter.outputs.tests_changed }}
      validation: ${{ steps.filter.outputs.validation }}
      property: ${{ steps.filter.outputs.property }}
      docs: ${{ steps.filter.outputs.docs }}
      workflows_changed: ${{ steps.filter.outputs.workflows_changed }}
      deps_changed: ${{ steps.filter.outputs.deps_changed }}
      docker_changed: ${{ steps.filter.outputs.docker_changed }}
      spec_changed: ${{ steps.filter.outputs.spec_changed }}
      unknown_changed: ${{ steps.filter.outputs.unknown_changed }}
      docs_only: ${{ steps.filter.outputs.docs_only }}
      dependency_manifest: ${{ steps.filter.outputs.dependency_manifest }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 2
      - name: Derive changed-file classes (PR truth via API)
        id: filter
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: python -m scripts.classify_changes --github-output "$GITHUB_OUTPUT"

  gate-profile:
    timeout-minutes: 10
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_gate_profile.yml
    with:
      profile: pr

  determinism:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' || needs.changes.outputs.deps_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]"
      - name: Test determinism (run 1)
        id: run1
        run: pytest tests/test_determinism.py tests/properties/test_properties_determinism.py -v --tb=short
      - name: Test determinism (run 2)
        id: run2
        run: pytest tests/test_determinism.py tests/properties/test_properties_determinism.py -v --tb=short
      - name: Test determinism (run 3)
        id: run3
        run: pytest tests/test_determinism.py tests/properties/test_properties_determinism.py -v --tb=short
      - name: Check RNG isolation
        id: rng
        run: pytest tests/test_determinism.py::test_no_global_numpy_rng_usage -v
      - name: Generate summary
        if: always()
        run: |
          summary_file="$GITHUB_STEP_SUMMARY"
          {
            echo "##  Determinism Verification (3x Runs)"
            echo ""
            echo "| Run | Status | Result |"
            echo "|-----|--------|--------|"
            if [ "${{ steps.run1.outcome }}" = "success" ]; then
              echo "| 1 |  PASS | Identical outputs |"
            else
              echo "| 1 |  FAIL | Non-deterministic |"
            fi
            if [ "${{ steps.run2.outcome }}" = "success" ]; then
              echo "| 2 |  PASS | Identical outputs |"
            else
              echo "| 2 |  FAIL | Non-deterministic |"
            fi
            if [ "${{ steps.run3.outcome }}" = "success" ]; then
              echo "| 3 |  PASS | Identical outputs |"
            else
              echo "| 3 |  FAIL | Non-deterministic |"
            fi
            echo ""
            echo "| Check | Status |"
            echo "|-------|--------|"
            if [ "${{ steps.rng.outcome }}" = "success" ]; then
              echo "| RNG Isolation |  PASS |"
            else
              echo "| RNG Isolation |  FAIL |"
            fi
            echo ""
            if [ "${{ steps.run1.outcome }}" = "success" ] && [ "${{ steps.run2.outcome }}" = "success" ] && [ "${{ steps.run3.outcome }}" = "success" ]; then
              echo "** All runs produced identical outputs (A1: Determinism 96%)**"
            else
              echo "** Determinism check failed**"
            fi
          } >> "$summary_file"


  contracts:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[test]"
      - name: Run no-escape contract tests
        run: |
          pytest -q             tests/test_actions_pinning.py             tests/test_no_escape_tripwires.py             tests/test_schema_contracts.py             tests/test_verify_reproducible_artifacts.py
      - name: Verify reproducible generated artifacts
        run: |
          python -m scripts.verify_reproducible_artifacts             --spec evidence/zqsg_2026_02_12/repro_spec.json             --runs 3             --report evidence/zqsg_2026_02_12/repro_report_ci.json
      - name: Upload contract artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: no-escape-contracts-${{ github.sha }}
          path: |
            evidence/zqsg_2026_02_12/repro_report_ci.json
          if-no-files-found: error
          retention-days: 30

  quality:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' || needs.changes.outputs.deps_changed == 'true'
    timeout-minutes: 20
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_quality.yml
    with:
      python-version: ${{ inputs['python-version'] || '3.11' }}
      mypy-strict: true
      pylint-threshold: 7.5

  build:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' || needs.changes.outputs.deps_changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]" build
      - name: Verify lockfile freshness (non-mutating)
        run: |
          python -m pip install pip-tools==7.5.3
          tmp_lock="$(mktemp)"
          export TMP_LOCK="$tmp_lock"
          python -m piptools compile --extra=dev --no-strip-extras --generate-hashes --output-file="$tmp_lock" pyproject.toml
          python - <<'PYLOCK'
          from __future__ import annotations

          from pathlib import Path
          import difflib
          import os

          lock = Path("requirements-lock.txt")
          generated = Path(os.environ["TMP_LOCK"])

          def _normalize(path: Path) -> list[str]:
              lines = path.read_text(encoding="utf-8").splitlines()
              idx = 0
              while idx < len(lines) and (lines[idx].startswith("#") or lines[idx] == ""):
                  idx += 1
              return [line + "\n" for line in lines[idx:]]

          expected = _normalize(lock)
          actual = _normalize(generated)

          if expected != actual:
              for line in difflib.unified_diff(expected, actual, fromfile=str(lock), tofile=str(generated)):
                  print(line, end="")
              raise SystemExit(1)

          print("Lockfile freshness: normalized content matches")
          PYLOCK
          sha256sum requirements-lock.txt "$tmp_lock"
      - run: python -m build
      - name: Install from wheel in clean venv
        run: |
          python -m venv .venv-wheel
          . .venv-wheel/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import bnsyn; print(bnsyn.__version__)"

  smoke-wheel-matrix:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' || needs.changes.outputs.deps_changed == 'true'
    name: smoke-wheel-matrix (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]" build
      - name: Smoke tests
        run: pytest -m smoke -v --tb=short
      - name: Build and install wheel
        run: |
          python -m build
          python -m venv .venv-wheel
          . .venv-wheel/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python -c "import bnsyn; print(bnsyn.__version__)"

  tests-smoke:
    needs: [changes, gate-profile]
    if: github.event_name != 'pull_request' || needs.changes.outputs.code_changed == 'true' || needs.changes.outputs.tests_changed == 'true' || needs.changes.outputs.deps_changed == 'true'
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_pytest.yml
    with:
      python-version: ${{ inputs['python-version'] || '3.11' }}
      markers: ${{ needs.gate-profile.outputs.pytest-markers }}
      coverage-threshold: ${{ fromJSON(needs.gate-profile.outputs.coverage-threshold) }}
      upload-codecov: ${{ inputs['upload-codecov'] || true }}
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  validation-tests-pr:
    needs: [changes, gate-profile]
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.validation == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'run-validation') ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_validation_tests.yml
    with:
      markers: ${{ needs.gate-profile.outputs.validation-markers }}
      timeout-minutes: ${{ fromJSON(needs.gate-profile.outputs.validation-timeout-minutes) }}
      summary-title: PR Validation Suite
      upload-artifacts: true
      artifact-name: validation-logs-pr

  property-tests-pr:
    needs: [changes, gate-profile]
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.property == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'run-property') ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    permissions:
      contents: read
    uses: ./.github/workflows/_reusable_property_tests.yml
    with:
      markers: ${{ needs.gate-profile.outputs.property-markers }}
      timeout-minutes: ${{ fromJSON(needs.gate-profile.outputs.property-timeout-minutes) }}
      hypothesis-profile: ci
      summary-title: PR Property-Based Invariants
      upload-artifacts: true
      artifact-name: property-logs-pr

  docs-pr:
    needs: changes
    if: >-
      github.event_name == 'pull_request' &&
      (needs.changes.outputs.docs == 'true' ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - run: python -m pip install -e ".[dev,test]"
      - name: Build docs
        run: make docs
      - name: Link check
        continue-on-error: true
        run: sphinx-build -b linkcheck docs docs/_build/linkcheck

  pr-description-policy:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Validate PR body sections and labels policy
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const body = (context.payload.pull_request?.body || '').toLowerCase();
            const requiredSections = ['what changed', 'why', 'risk', 'evidence', 'how to test'];
            const missing = requiredSections.filter((section) => !body.includes(section));
            const labels = (context.payload.pull_request?.labels || []).map((l) => l.name);
            const allowed = new Set(['run-property', 'run-validation', 'run-codeql', 'heavy-ci']);
            const unknown = labels.filter((name) => name.startsWith('run-') && !allowed.has(name));
            if (missing.length > 0) {
              core.warning(`PR description is missing recommended sections: ${missing.join(', ')}`);
            }
            if (unknown.length > 0) {
              core.setFailed(`Unknown run-* labels found: ${unknown.join(', ')}`);
              return;
            }
            core.info('PR description and labels policy checks passed.');

  ssot:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]"
      - run: python -m scripts.validate_bibliography
      - run: python -m scripts.validate_claims
      - run: python -m scripts.scan_governed_docs
      - run: python -m scripts.scan_normative_tags
      - run: python -m scripts.validate_api_maturity
      - run: python -m scripts.validate_status_claims
      - run: make api-contract
      - run: python -m tools.manifest generate
      - run: python -m tools.manifest validate
      - name: Verify manifest artifacts are in sync
        run: |
          if ! git diff --exit-code -- .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json; then
            echo "::error::.github/REPO_MANIFEST.md and/or manifest/repo_manifest.computed.json are out of date. Run: python -m tools.manifest generate && git add .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json"
            git --no-pager diff -- .github/REPO_MANIFEST.md manifest/repo_manifest.computed.json
            exit 1
          fi

  security:
    needs: changes
    if: github.event_name != 'pull_request' || needs.changes.outputs.docs_only != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ inputs['python-version'] || '3.11' }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            requirements-lock.txt
      - name: Pin pip
        uses: ./.github/actions/pin-pip
      - name: Log pip version
        run: python -m pip --version
      - run: python -m pip install -e ".[dev,test]"
      - name: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
      - name: pip-audit
        if: github.event_name != 'pull_request' || needs.changes.outputs.deps_changed == 'true'
        run: |
          mkdir -p artifacts
          pip-audit --desc --format json --output artifacts/pip-audit.json
      - name: bandit
        run: bandit -r src/ -ll
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        if: always()
        with:
          name: security-report-${{ github.sha }}
          path: artifacts/pip-audit.json
          if-no-files-found: ignore
          retention-days: 30

  codeql-pr:
    if: >-
      github.event_name == 'pull_request' &&
      (contains(github.event.pull_request.labels.*.name, 'run-codeql') ||
      contains(github.event.pull_request.labels.*.name, 'heavy-ci'))
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      - name: Initialize CodeQL
        uses: github/codeql-action/init@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a
        with:
          languages: "python"
          build-mode: none
      - name: Analyze
        uses: github/codeql-action/analyze@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a


  finalize:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    needs:
      - changes
      - gate-profile
      - determinism
      - contracts
      - quality
      - build
      - smoke-wheel-matrix
      - tests-smoke
      - ssot
      - security
      - pr-description-policy
    if: always()
    steps:
      - name: Merge gate verdict (fail-closed)
        shell: bash
        run: |
          set -euo pipefail

          docs_only="${{ needs.changes.outputs.docs_only }}"
          workflows_changed="${{ needs.changes.outputs.workflows_changed }}"
          deps_changed="${{ needs.changes.outputs.deps_changed }}"
          code_changed="${{ needs.changes.outputs.code_changed }}"
          tests_changed="${{ needs.changes.outputs.tests_changed }}"
          spec_changed="${{ needs.changes.outputs.spec_changed }}"
          unknown_changed="${{ needs.changes.outputs.unknown_changed }}"

          fail() {
            echo "::error::$1"
            exit 1
          }

          require_success() {
            local name="$1"
            local result="$2"
            if [[ "$result" != "success" ]]; then
              fail "Required gate failed or did not run: ${name} result=${result}"
            fi
          }

          require_success_or_skipped() {
            local name="$1"
            local result="$2"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              fail "Gate failed: ${name} result=${result}"
            fi
          }

          require_success "changes" "${{ needs.changes.result }}"
          echo "EVIDENCE: flags docs_only=${docs_only} workflows_changed=${workflows_changed} deps_changed=${deps_changed} code_changed=${code_changed} tests_changed=${tests_changed} spec_changed=${spec_changed} unknown_changed=${unknown_changed}"

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            require_success "pr-description-policy" "${{ needs.pr-description-policy.result }}"
          fi

          if [[ "$docs_only" == "true" ]]; then
            if [[ "$workflows_changed" == "true" || "$deps_changed" == "true" || "$code_changed" == "true" || "$tests_changed" == "true" || "$spec_changed" == "true" || "$unknown_changed" == "true" ]]; then
              fail "docs_only=true but sensitive change flags set"
            fi
            echo "EVIDENCE: docs_only=true heavy_gates=skipped"
            exit 0
          fi

          require_success "gate-profile" "${{ needs.gate-profile.result }}"
          require_success "contracts" "${{ needs.contracts.result }}"
          require_success "security" "${{ needs.security.result }}"
          require_success "ssot" "${{ needs.ssot.result }}"

          if [[ "$code_changed" == "true" || "$deps_changed" == "true" || "$tests_changed" == "true" || "$unknown_changed" == "true" ]]; then
            require_success "quality" "${{ needs.quality.result }}"
            require_success "build" "${{ needs.build.result }}"
            require_success "tests-smoke" "${{ needs.tests-smoke.result }}"
            require_success "determinism" "${{ needs.determinism.result }}"
            require_success "smoke-wheel-matrix" "${{ needs.smoke-wheel-matrix.result }}"
          else
            require_success_or_skipped "quality" "${{ needs.quality.result }}"
            require_success_or_skipped "build" "${{ needs.build.result }}"
            require_success_or_skipped "tests-smoke" "${{ needs.tests-smoke.result }}"
            require_success_or_skipped "determinism" "${{ needs.determinism.result }}"
            require_success_or_skipped "smoke-wheel-matrix" "${{ needs.smoke-wheel-matrix.result }}"
          fi

          echo "EVIDENCE: merge_gate=PASS"
