#!/usr/bin/env python3
from __future__ import annotations

import argparse
import hashlib
import json
import shlex
import subprocess
from datetime import datetime, timezone
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
ART = ROOT / "artifacts" / "sse_sdo"
LOGDIR = ART / "logs"
XRUN = ART / "proofs" / "xrun"


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument("command")
    parser.add_argument("--id", dest="rid", default="run")
    args = parser.parse_args()

    LOGDIR.mkdir(parents=True, exist_ok=True)
    XRUN.mkdir(parents=True, exist_ok=True)

    stamp = datetime.now(timezone.utc).strftime("%Y%m%dT%H%M%SZ")
    record_id = f"{args.rid}_{stamp}"
    log_path = LOGDIR / f"{record_id}.log"
    rec_path = XRUN / f"{record_id}.json"

    proc = subprocess.run(args.command, shell=True, cwd=ROOT, text=True, capture_output=True)
    log_text = (proc.stdout or "") + (proc.stderr or "")
    log_path.write_text(log_text, encoding="utf-8")
    sha = hashlib.sha256(log_path.read_bytes()).hexdigest()

    rec = {
        "id": record_id,
        "cmd": args.command,
        "argv": shlex.split(args.command),
        "exit_code": proc.returncode,
        "log": str(log_path.relative_to(ROOT)),
        "log_sha256": sha,
        "timestamp_utc": stamp,
    }
    rec_path.write_text(json.dumps(rec, indent=2, sort_keys=True) + "\n", encoding="utf-8")
    print(json.dumps(rec, sort_keys=True))
    return proc.returncode


if __name__ == "__main__":
    raise SystemExit(main())
